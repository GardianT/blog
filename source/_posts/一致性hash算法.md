---
title: 一致性hash算法与负载均衡
date: 2019-03-14 20:41:33
tags: 
    - 一致性hash
    - 负载均衡
---

## 一致性hash

[一致性hash原理](https://www.cnblogs.com/lpfuture/p/5796398.html)

好的一致性算法应该有什么特性，这个文章里有一段讲述的非常准确，基本完全match线上生产环境了：

> **平衡性(Balance)**
>平衡性是指哈希的结果能够尽可能分布到所有的缓冲中去，这样可以使得所有的缓冲空间都得到利用。很多哈希算法都能够满足这一条件。
>
> **单调性(Monotonicity)**
>单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲区加入到系统中，那么哈希的结果应能够保证原有已分配的内容可以被映射到新的缓冲区中去，而不会被映射到旧的缓冲集合中的其他缓冲区。简单的哈希算法往往不能满足单调性的要求，如最简单
>的线性哈希：x = (ax + b) mod (P)，在上式中，P表示全部缓冲的大小。不难看出，当缓冲大小发生变化时(从P1到P2)，原来所有的哈希结果均会发生变化，从而不满足单调性的要求。哈希结果的变化意味着当缓冲空间发生变化时，所有的映射关系需要在系统内全部
>更新。而在P2P系统内，缓冲的变化等价于Peer加入或退出系统，这一情况在P2P系统中会频繁发生，因此会带来极大计算和传输负荷。单调性就是要求哈希算法能够应对这种情况。
>
> **分散性(Spread)**
>在分布式环境中，终端有可能看不到所有的缓冲，而是只能看到其中的一部分。当终端希望通过哈希过程将内容映射到缓冲上时，由于不同终端所见的缓冲范围有可能不同，从而导致哈希的结果不一致，最终的结果是相同的内容被不同的终端映射到不同的缓冲区中。这种情况显
>然是应该避免的，因为它导致相同内容被存储到不同缓冲中去，降低了系统存储的效率。分散性的定义就是上述情况发生的严重程度。好的哈希算法应能够尽量避免不一致的情况发生，也就是尽量降低分散性。
>
> **负载(Load)**
>负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。与分散性一样，这种情况也是应当避免的，因此好的哈希算法应能够尽量降低缓冲的负荷。
>
> **平滑性(Smoothness)**
>平滑性是指缓存服务器的数目平滑改变和缓存对象的平滑改变是一致的。

### consistent hashing

[consistent_hashing](https://github.com/apache/incubator-brpc/blob/master/docs/cn/consistent_hashing.md)  

- 把所有server的处理区间视为一个环。比如[0, 1000)这样一个range，1000和0相连
- 每个server会扩充v倍形成虚拟节点，随机的插入到range内。如果有n个server，那就是vn个虚拟节点。
- 插入到range内是随机的；也就是说consistent hashing的虚拟节点 **并不保证就能均匀分割区间了。**。但是扩充的越大，区间就越可能趋近于均匀。比如[0, 1000)，如果你扩充出来1000个虚拟节点，那就一定均匀了。所以一定要理解，虚拟节点的存在才是一致性hash能解决热点问题的关键。但是扩充太多同样影响查找的性能。所以扩充多少也要结合实际。在brpc里这个数字是100，也就是每个server扩充100个虚拟节点。
- 查找比较简单，就是计算hash值，寻找虚拟节点vector的bound。如果bound到了边界，返回边界的节点（形成环）。这样解决了宕机掉节点问题：如果一个机器宕机，当hash到与这个机器对应的range的时候，由于这个虚拟节点
（对应的真实server）已经宕机，所以他会继续寻找bound。而由于虚拟节点是随机插入的，所以也能保证server宕机的时候，他负责的range会被随机的其他若干server承担。
- hash算法（比如murmurhash）可以保证哪怕输入有规律的情况下，hash也是随机的。所以就可以保证请求散落全环。

总结：consistent hash利用虚拟节点解决热点和宕机的问题。 **然而实际上consistent hash是否真的适用，要结合业务场景考虑。** 比如murmurhash的引入，会让有规律的输入也会随机hash，这样是否导致了consistent hash的分散性有较大问题；而如果没有murmurhash，是否又会导致平衡性出现问题。

### Rendezvous hashing

## 负载均衡

[locality-aware load balancing](https://github.com/apache/incubator-brpc/blob/master/docs/cn/lalb.md)
